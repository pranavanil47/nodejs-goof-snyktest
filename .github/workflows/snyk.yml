name: Snyk Universal Scan (clone, auth in-run)

on:
  push:
    branches: ["main","master"]
  pull_request:

permissions:
  contents: read

jobs:
  snyk-scan:
    runs-on: ubuntu-latest
    env:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

    steps:
      - name: Prepare workspace
        run: mkdir -p repo-src

      - name: Clone repository (shallow)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git clone --depth 1 https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }} repo-src
          rm -rf repo-src/.github || true

      - name: Install Snyk CLI
        run: npm install -g snyk@latest

      - name: Authenticate Snyk CLI
        run: snyk auth $SNYK_TOKEN

      - name: Run Snyk SCA / Code / IaC / Container (if relevant)
        working-directory: repo-src
        run: |
          snyk test || true
          snyk code test --sarif > "$GITHUB_WORKSPACE/snyk-code.sarif" || true
          snyk iac test || true
          if [ -f Dockerfile ]; then
            docker build -t snyk-image . || true
            snyk container test snyk-image --file=Dockerfile || true
          fi
          snyk monitor

      - name: Upload SARIF (if generated)
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: snyk-code.sarif
          
